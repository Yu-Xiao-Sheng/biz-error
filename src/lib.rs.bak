// ğŸ“¦ biz-error: ä¸šåŠ¡é”™è¯¯ç ç®¡ç†æ¡†æ¶
//
// ğŸ’¡ æä¾›ä¸šåŠ¡é”™è¯¯å¤„ç†çš„åŸºç±»å’Œå·¥å…·
// ğŸŒ æ”¯æŒå›½é™…åŒ–é”™è¯¯æ¶ˆæ¯
// ğŸ¯ æä¾› AppError åŸºç±»ï¼Œæ”¯æŒè‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸
//
// # ä½¿ç”¨æ–¹å¼
//
// 1. åœ¨ä½ çš„é¡¹ç›®ä¸­æ·»åŠ  `biz-error` ä½œä¸ºä¾èµ–
// 2. æ·»åŠ  `biz-error-codegen` ä½œä¸º build-dependency
// 3. åˆ›å»º `biz_errors.yaml` é…ç½®æ–‡ä»¶
// 4. åœ¨ `build.rs` ä¸­è°ƒç”¨ä»£ç ç”Ÿæˆ
// 5. åœ¨ `lib.rs` æˆ– `main.rs` ä¸­å¼•å…¥ç”Ÿæˆçš„æ¨¡å—
//
// ## build.rs ç¤ºä¾‹
//
// ```no_run
// fn main() {
//     biz_error_codegen::generate_error_codes(
//         "biz_errors.yaml",
//         "src/error_codes.rs"
//     ).expect("Failed to generate error codes");
// }
// ```
//
// ## lib.rs/main.rs ç¤ºä¾‹
//
// ```ignore
// mod error_codes;  // å¼•å…¥ç”Ÿæˆçš„é”™è¯¯ç æ¨¡å—
//
// use biz_error::AppError;
// use crate::error_codes::ErrorCode;
// ```

use serde::Serialize;
use serde_json::Value;
use std::fmt;

#[cfg(feature = "axum")]
use axum::{
    response::{IntoResponse, Response},
    Json,
};

// ============================================
// é”™è¯¯å“åº”ç»“æ„
// ============================================

/// æ ‡å‡†é”™è¯¯å“åº”ä½“
///
/// # å­—æ®µè¯´æ˜
/// - `code`: é”™è¯¯ç ï¼ˆæ•°å­—ï¼‰
/// - `msg`: é”™è¯¯æ¶ˆæ¯ï¼ˆæ ¹æ®è¯­è¨€è‡ªåŠ¨é€‰æ‹©ï¼‰
/// - `data`: å¯é€‰çš„é™„åŠ æ•°æ®
///
/// # Examples
///
/// ```json
/// {
///   "code": 4000,
///   "msg": "INVALID PARAMETER",
///   "data": {
///     "field": "user_id",
///     "reason": "must be greater than 0"
///   }
/// }
/// ```
#[derive(Debug, Clone, Serialize)]
pub struct ErrorResponse {
    /// é”™è¯¯ç 
    pub code: i32,
    /// é”™è¯¯æ¶ˆæ¯
    pub msg: String,
    /// å¯é€‰çš„é™„åŠ æ•°æ®
    #[serde(skip_serializing_if = "Option::is_none")]
    pub data: Option<Value>,
}

impl ErrorResponse {
    /// ä» ErrorCode åˆ›å»ºå“åº”
    pub fn from_error_code(error_code: ErrorCode) -> Self {
        Self {
            code: error_code.code(),
            msg: error_code.message().to_string(),
            data: None,
        }
    }

    /// è®¾ç½®è‡ªå®šä¹‰æ¶ˆæ¯
    pub fn with_msg(mut self, msg: impl Into<String>) -> Self {
        self.msg = msg.into();
        self
    }

    /// è®¾ç½®é™„åŠ æ•°æ®
    pub fn with_data(mut self, data: Value) -> Self {
        self.data = Some(data);
        self
    }
}

impl From<ErrorCode> for ErrorResponse {
    fn from(error_code: ErrorCode) -> Self {
        Self::from_error_code(error_code)
    }
}

// ============================================
// AppError åŸºç±» - ä¸šåŠ¡é”™è¯¯çš„é¡¶çº§æŠ½è±¡
// ============================================

/// ä¸šåŠ¡é”™è¯¯åŸºç±»
///
/// è¿™æ˜¯æ‰€æœ‰ä¸šåŠ¡é”™è¯¯çš„é¡¶çº§æŠ½è±¡ï¼Œç±»ä¼¼äº Java çš„å¼‚å¸¸åŸºç±»ã€‚
///
/// # æ ¸å¿ƒç‰¹æ€§
/// - **code**: é”™è¯¯ç ï¼ˆé€šè¿‡ ErrorCode æšä¸¾è·å–ï¼‰
/// - **msg**: é”™è¯¯æ¶ˆæ¯ï¼ˆæ”¯æŒè‡ªå®šä¹‰è¦†ç›–é»˜è®¤æ¶ˆæ¯ï¼‰
/// - **data**: å¯é€‰çš„ä¸šåŠ¡æ•°æ®ï¼ˆæºå¸¦é”™è¯¯ä¸Šä¸‹æ–‡ï¼‰
///
/// # è®¾è®¡ç†å¿µ
///
/// ```text
///     AppError (åŸºç±»)
///          â†‘
///          â”‚ ç»§æ‰¿/ç»„åˆ
///          â”œâ”€ UserError
///          â”œâ”€ OrderError
///          â””â”€ PaymentError
/// ```
///
/// # Examples
///
/// ## åŸºç¡€ä½¿ç”¨
///
/// ```rust
/// use biz_error::AppError;
///
/// // ç›´æ¥ä½¿ç”¨ ErrorCode åˆ›å»º
/// let error = AppError::new(biz_error::ErrorCode::InvalidParam);
/// assert_eq!(error.code(), 4000);
/// ```
///
/// ## è‡ªå®šä¹‰æ¶ˆæ¯å’Œæ•°æ®
///
/// ```rust
/// use biz_error::AppError;
/// use serde_json::json;
///
/// let error = AppError::new(biz_error::ErrorCode::InvalidParam)
///     .with_msg("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")
///     .with_data(json!({ "field": "user_id" }));
/// ```
///
/// ## è‡ªå®šä¹‰ä¸šåŠ¡é”™è¯¯ç±»å‹
///
/// ```rust
/// use biz_error::{AppError, ErrorCode};
/// use serde_json::Value;
///
/// /// ç”¨æˆ·ç›¸å…³é”™è¯¯
/// pub struct UserError(AppError);
///
/// impl UserError {
///     /// ç”¨æˆ·ä¸å­˜åœ¨
///     pub fn not_found(id: u64) -> Self {
///         Self(AppError::new(ErrorCode::NotFound)
///             .with_msg(format!("ç”¨æˆ· {} ä¸å­˜åœ¨", id))
///             .with_data(serde_json::json!({ "user_id": id })))
///     }
///
///     /// ç”¨æˆ·å·²å­˜åœ¨
///     pub fn already_exists(email: &str) -> Self {
///         Self(AppError::new(ErrorCode::AlreadyExists)
///             .with_msg(format!("ç”¨æˆ· {} å·²å­˜åœ¨", email)))
///     }
/// }
///
/// // åœ¨ handler ä¸­ä½¿ç”¨
/// pub async fn get_user(id: u64) -> Result<User, UserError> {
///     if id == 0 {
///         return Err(UserError::not_found(id));
///     }
///     // ...
/// }
/// ```
#[derive(Debug, Clone)]
pub struct AppError {
    /// é”™è¯¯ç 
    error_code: ErrorCode,
    /// è‡ªå®šä¹‰æ¶ˆæ¯ï¼ˆè¦†ç›–é»˜è®¤æ¶ˆæ¯ï¼‰
    custom_msg: Option<String>,
    /// é™„åŠ æ•°æ®
    data: Option<Value>,
}

impl AppError {
    /// åˆ›å»ºæ–°çš„ä¸šåŠ¡é”™è¯¯
    ///
    /// # Examples
    ///
    /// ```
    /// use biz_error::{AppError, ErrorCode};
    ///
    /// let error = AppError::new(ErrorCode::InvalidParam);
    /// ```
    pub fn new(error_code: ErrorCode) -> Self {
        Self {
            error_code,
            custom_msg: None,
            data: None,
        }
    }

    /// è®¾ç½®è‡ªå®šä¹‰æ¶ˆæ¯
    ///
    /// # Examples
    ///
    /// ```
    /// use biz_error::{AppError, ErrorCode};
    ///
    /// let error = AppError::new(ErrorCode::InvalidParam)
    ///     .with_msg("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
    /// ```
    pub fn with_msg(mut self, msg: impl Into<String>) -> Self {
        self.custom_msg = Some(msg.into());
        self
    }

    /// è®¾ç½®é™„åŠ æ•°æ®
    ///
    /// # Examples
    ///
    /// ```
    /// use biz_error::{AppError, ErrorCode};
    /// use serde_json::json;
    ///
    /// let error = AppError::new(ErrorCode::InvalidParam)
    ///     .with_data(json!({ "field": "user_id" }));
    /// ```
    pub fn with_data(mut self, data: Value) -> Self {
        self.data = Some(data);
        self
    }

    /// è·å–é”™è¯¯ç æšä¸¾
    pub fn error_code(&self) -> ErrorCode {
        self.error_code
    }

    /// è·å–æ•°å­—é”™è¯¯ç 
    pub fn code(&self) -> i32 {
        self.error_code.code()
    }

    /// è·å–é”™è¯¯æ¶ˆæ¯
    pub fn msg(&self) -> &str {
        self.custom_msg
            .as_deref()
            .unwrap_or_else(|| self.error_code.message())
    }

    /// è·å–é™„åŠ æ•°æ®
    pub fn data(&self) -> Option<&Value> {
        self.data.as_ref()
    }

    /// è½¬æ¢ä¸º ErrorResponse
    pub fn to_response(&self) -> ErrorResponse {
        let mut resp = ErrorResponse::from_error_code(self.error_code);
        if let Some(ref msg) = self.custom_msg {
            resp = resp.with_msg(msg);
        }
        if let Some(ref data) = self.data {
            resp = resp.with_data(data.clone());
        }
        resp
    }

    /// åˆ›å»ºå¸¦æ•°æ®çš„é”™è¯¯ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
    pub fn with_code_and_data(error_code: ErrorCode, data: Value) -> Self {
        Self::new(error_code).with_data(data)
    }
}

impl fmt::Display for AppError {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        write!(f, "[{}] {}", self.code(), self.msg())
    }
}

impl std::error::Error for AppError {}

// ============================================
// From å®ç°å¸¸è§é”™è¯¯ç±»å‹
// ============================================

impl From<ErrorCode> for AppError {
    fn from(error_code: ErrorCode) -> Self {
        Self::new(error_code)
    }
}

#[cfg(feature = "anyhow")]
impl From<anyhow::Error> for AppError {
    fn from(err: anyhow::Error) -> Self {
        Self::new(ErrorCode::InternalError).with_msg(err.to_string())
    }
}

#[cfg(feature = "axum")]
impl IntoResponse for AppError {
    fn into_response(self) -> Response {
        let status = self.error_code.http_status();
        let resp = self.to_response();
        (status, Json(resp)).into_response()
    }
}

#[cfg(feature = "axum")]
impl IntoResponse for ErrorCode {
    fn into_response(self) -> Response {
        let status = self.http_status();
        let resp = ErrorResponse::from_error_code(self);
        (status, Json(resp)).into_response()
    }
}

// ============================================
// ä¾¿æ·å®
// ============================================

/// åˆ›å»ºä¸šåŠ¡é”™è¯¯çš„ä¾¿æ·å®
///
/// # Examples
///
/// ```rust
/// use biz_error::biz_err;
/// use serde_json::json;
///
/// // åŸºç¡€ç”¨æ³•
/// let error = biz_err!(InvalidParam);
///
/// // å¸¦è‡ªå®šä¹‰æ¶ˆæ¯
/// let error = biz_err!(InvalidParam, "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
///
/// // å¸¦æ•°æ®
/// let error = biz_err!(InvalidParam, data: json!({ "field": "user_id" }));
///
/// // å®Œæ•´ç”¨æ³•
/// let error = biz_err!(InvalidParam, "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", data: json!({ "field": "user_id" }));
/// ```
#[macro_export]
macro_rules! biz_err {
    ($error_code:ident) => {
        $crate::AppError::new($crate::ErrorCode::$error_code)
    };
    ($error_code:ident, $msg:expr) => {
        $crate::AppError::new($crate::ErrorCode::$error_code).with_msg($msg)
    };
    ($error_code:ident, data: $data:expr) => {
        $crate::AppError::new($crate::ErrorCode::$error_code).with_data($data)
    };
    ($error_code:ident, $msg:expr, data: $data:expr) => {
        $crate::AppError::new($crate::ErrorCode::$error_code)
            .with_msg($msg)
            .with_data($data)
    };
}

/// åˆ›å»ºå¸¦è‡ªå®šä¹‰æ¶ˆæ¯çš„é”™è¯¯çš„ä¾¿æ·å®
///
/// # Examples
///
/// ```rust
/// use biz_error::biz_err_msg;
///
/// let error = biz_err_msg!(InvalidParam, "ç”¨æˆ·IDæ ¼å¼é”™è¯¯");
/// ```
#[macro_export]
macro_rules! biz_err_msg {
    ($error_code:ident, $msg:expr) => {
        $crate::AppError::new($crate::ErrorCode::$error_code).with_msg($msg)
    };
}

/// åˆ›å»ºå¸¦æ•°æ®çš„é”™è¯¯çš„ä¾¿æ·å®
///
/// # Examples
///
/// ```rust
/// use biz_error::biz_err_data;
/// use serde_json::json;
///
/// let error = biz_err_data!(InvalidParam, json!({ "field": "user_id" }));
/// ```
#[macro_export]
macro_rules! biz_err_data {
    ($error_code:ident, $data:expr) => {
        $crate::AppError::new($crate::ErrorCode::$error_code).with_data($data)
    };
}
